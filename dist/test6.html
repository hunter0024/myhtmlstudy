
<link rel="stylesheet" href="./test6Style.css">

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

<div class="estimate_detail_contants">
    <div class="estimateDetail_profile_infoWra">
        <div class="estimateDetail_profile_textArea">
            <h1 class="estimateDetail_profile_name">
                    제목
            </h1>
            <div class="estimateDetail_profile_categoryBox">
                <span class="estimateDetail_profile_categoryItem">카테고리</span>
            </div>
            <p class="estimateDetail_profile_count">
                <span>강조</span> 광고
            </p>

            <div class="price_box">
                <span class="valid_price">2,000,000원</span>
                <div class="add_price_info">
                    <span class="vat_info">*부가세 별도</span>
                </div>
            </div>
                                                                    
            <div class="select_option_wrap">
                <div class="select_option_area">
                    <div class="select_option_label">추가 상품</div>
                    <div class="select_option_dropdown">
                        <div class="select_dropdown page_option ext_prod_data">
                            <button type="button" class="dropdown_toggle"><span>음향 시스템</span></button>
                            <ul class="dropdown_content">
                                    <li>
                                        <button type="button" class="dropdown_item page_option_item ext_prod_info">
                                            <span class="prod_info_val">음향 시스템 및 감독  </span>
                                            <span>(+2,500,000원)</span>
                                        </button>
                                    </li>
                            </ul>
                        </div>
                        <div class="select_dropdown page_option ext_prod_data">
                            <button type="button" class="dropdown_toggle"><span>조명 시스템</span></button>
                            <ul class="dropdown_content">
                                    <li>
                                        <button type="button" class="dropdown_item page_option_item ext_prod_info">
                                            <span class="prod_info_val">조명 시스템 및 감독  </span>
                                            <span>(+3,000,000원)</span>
                                        </button>
                                    </li>
                            </ul>
                        </div>
                        <div class="select_dropdown page_option ext_prod_data">
                            <button type="button" class="dropdown_toggle"><span>안내데스크</span></button>
                            <ul class="dropdown_content">
                                    <li>
                                        <button type="button" class="dropdown_item page_option_item ext_prod_info">
                                            <span class="prod_info_val">테이블+제작물+배너2종  </span>
                                            <span>(+400,000원)</span>
                                        </button>
                                    </li>
                            </ul>
                        </div>
                    </div> 
                </div>
                <ul class="select_option_list page_selected_options">

                </ul>
            </div>                            
            <!-- // v1.0.0 옵션 선택 -->
            <div class="btn_box bottom_menu">
                <div class="harf_box">
                    <!-- <a href="https://red-slippers.imweb.me/16" class="link_expert_purple event_question_btn" onclick="gtag('event', '견적 문의하기 버튼', {'event_category': 'directOffer', 'event_label': '버튼 클릭'});">
                        견적 문의하기
                    </a> -->

                    <a href="test7.html" class="link_expert_purple event_question_btn" >
                        견적 문의하기
                    </a>
                    <a class="storage_btn link_expert_purple event_question_btn" >
                        스토리지저장
                    </a>
                    <a class="storage_load_btn link_expert_purple event_question_btn" >
                        스토리지로드
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
/* 변수 선언*/
let priceType = 'fixed';
let includeVatFlag = 'n';

let option_data = JSON.parse('[]');
let selected_options = Array(option_data.length);

let ext_prod_data = JSON.parse('[{"label":"\uc74c\ud5a5 \uc2dc\uc2a4\ud15c","extProd":[{"value":"\uc74c\ud5a5 \uc2dc\uc2a4\ud15c \ubc0f \uac10\ub3c5","price":"2500000","type":"quantity"}]},{"label":"\uc870\uba85 \uc2dc\uc2a4\ud15c","extProd":[{"value":"\uc870\uba85 \uc2dc\uc2a4\ud15c \ubc0f \uac10\ub3c5","price":"3000000","type":"quantity"}]},{"label":"\uc548\ub0b4\ub370\uc2a4\ud06c","extProd":[{"value":"\ud14c\uc774\ube14+\uc81c\uc791\ubb3c+\ubc30\ub1082\uc885","price":"400000","type":"quantity"}]},{"label":"\ubbf8\ub514\uc5b4 \uba85\ucc30 \ubc0f \uc785\uc7a5 \ud314\ucc0c","extProd":[{"value":"100\uc778 \uae30\uc900","price":"270000","type":"quantity"}]},{"label":"\ud3ec\ud1a0\uc874 \uc81c\uc791","extProd":[{"value":"\ud2b8\ub7ec\uc2a4 \ub610\ub294 \ud48d\uc120\uc544\uce58","price":"1000000","type":"quantity"}]},{"label":"\uc2dc\uc0c1 \ubcf4\ub4dc","extProd":[{"value":"1\uac1c (\ub514\uc790\uc778 \ubcc4\ub3c4)","price":"50000","type":"quantity"}]},{"label":"\ud589\uc0ac \uc2a4\ucf00\uce58","extProd":[{"value":"\uc0ac\uc9c4&\uc601\uc0c1 \ucd2c\uc601","price":"500000","type":"quantity"}]}]');

let addWorkPrice = '0';
let basicPrice = 0;
let allPrice = 0;

/* 함수 선언*/
function imgSkeletonLoading(targetClass) {

    console.log('imgSkeletonLoading');

    $(targetClass).each(function () {
        let imageBox = $(this);
        if (imageBox.is(".loaded")) {
            return;
        }

        let backgroundImageUrl = imageBox.data("bg-image");
        imageBox.addClass("skeleton");

        if (imageBox.is(".estimateDetail_profile_imgWra")) {
            let imageDivs = imageBox.find(".swiper-slide");
            let loadingCount = imageDivs.length;
            $(imageDivs).each(function () {
                let imageDiv = $(this);
                backgroundImageUrl = $(imageDiv).data("bg-image");
                $(imageDiv).css(
                    "background-image",
                    "url(" + backgroundImageUrl + ")"
                );

                // 이미지 로딩 완료 시 처리
                let image = new Image();
                image.src = backgroundImageUrl;
                image.onload = function () {
                    loadingCount--;
                    if (loadingCount === 0) {
                        imageBox.removeClass("skeleton");
                        imageBox.addClass("loaded");
                    }
                };

                image.onerror = function () {
                    imageBox.removeClass("skeleton");
                    imageBox.addClass("loaded");
                };
            });
        } else if (
            imageBox.is(".estimateDetail_movie_item") ||
            imageBox.is(".video")
        ) {
            let iframe = $(this).find("iframe")[0];
            $(iframe).on("load", function () {
                imageBox.removeClass("skeleton");
                imageBox.addClass("loaded");
            });
        } else {
            if (imageBox.is(".img_wrapper")) {
                let imageDiv = imageBox.find(".img")[0];
                $(imageDiv).css(
                    "background-image",
                    "url(" + backgroundImageUrl + ")"
                );
            } else if (
                imageBox.is(".main_plan_item") ||
                imageBox.is(".liveMov")
            ) {
                let imgTag = imageBox.find("img")[0];
                $(imgTag).attr("src", backgroundImageUrl);
            } else {
                // 배경 이미지 URL 설정
                imageBox.css(
                    "background-image",
                    "url(" + backgroundImageUrl + ")"
                );
            }

            if (backgroundImageUrl == "") {
                imageBox.removeClass("skeleton");
                imageBox.addClass("loaded");
            }

            // 이미지 로딩 완료 시 처리
            let image = new Image();
            image.src = backgroundImageUrl;

            image.onload = function () {
                imageBox.removeClass("skeleton");
                imageBox.addClass("loaded");
            };

            image.onerror = function () {
                imageBox.removeClass("skeleton");
                imageBox.addClass("loaded");
            };
        }
    });
}

function optionSelect(isPage, clickItem) {

    console.log('optionSelect');

    let type = isPage ? "page" : "popup";

    var parent = $(clickItem).closest(`.${type}_option`);

    if($(clickItem).hasClass('ext_prod_info')) {            
        var extProdIdx = $(`.${type}_option.ext_prod_data`).index(parent);
        var extProdValIdx = parent.find(`.${type}_option_item`).index(clickItem);
        var selectExtProdData = (ext_prod_data[extProdIdx].extProd[extProdValIdx]);
        var selectExtProdVal = selectExtProdData.value;

        $(parent).children('.dropdown_toggle').children('span').text(ext_prod_data[extProdIdx].label);   
        let dupCnt = $(".prod_info_val").filter(function() { 
            return $(this).text().trim() === selectExtProdVal
        }).length;

        if(dupCnt > 1) {
            selectExtProdVal = selectExtProdData.value + ` (${ext_prod_data[extProdIdx].label})` 
        }

        var isDuplicateExtProd = false;

        $(`.select_option_info span`).each(function() {
            if($(this).text() === selectExtProdVal) {
                alert('이미 추가된 상품입니다.')
                isDuplicateExtProd = true;
                return false; 
            }
        })

        if(!isDuplicateExtProd){
            allPrice += parseInt(selectExtProdData.price);
            add_select_option_item(selectExtProdVal, parseInt(selectExtProdData.price), isPage, selectExtProdData.type, true);
        }
        
    }else {
        parent.addClass('option_selected');
        var optionIdx = $(`.${type}_option.option_data`).index(parent);
        var optionValIdx = parent.find(`.${type}_option_item`).index(clickItem);

        // selected_options에 값이 있을 경우엔 값 수정, 없을 경우 값 추가
        selected_options[optionIdx] = (option_data[optionIdx].option[optionValIdx]);
        
        if($(`.${type}_option.option_data`).length == $('.option_selected').length) {
            var selectedValueStr = selected_options.map(v => v.value).join(" / ");


            var isDuplicateOption = false;

            $(`.select_option_info span`).each(function() {
                if($(this).text() === selectedValueStr) {
                    alert('이미 추가된 옵션입니다.')
                    isDuplicateOption = true;
                    return false; 
                }
            })

            if(!isDuplicateOption) {
                let optionType = 'quantity';
                var optionPrice = selected_options.map(v => parseInt(v.price)).reduce((acc, curr) => acc + curr,  priceType != 'fixed' ? 0 : basicPrice);
                allPrice += optionPrice;
                add_select_option_item(selectedValueStr, optionPrice, isPage, optionType);
            }
            
            
            $(`.${type}_option.option_data`).removeClass('option_selected');
            selected_options = Array($(`.${type}_option.option_data`).length);

            $(`.${type}_option.option_data`).each(function() {
                $(this).children('.dropdown_toggle').children('span').text(option_data[$(`.${type}_option`).index(this)].label);
            });
        }
    }        
}


//닫기 버튼
$('.page_selected_options, .popup_selected_options').on('click','.btn_close',function() {
    console.log('btn_close');

    let idx = $(this).closest('.select_option_item').index();
    let pageCloseOption = $('.page_selected_options .select_option_item').eq(idx);
    let popupCloseOption =  $('.popup_selected_options .select_option_item').eq(idx);

    pageCloseOption.remove();
    popupCloseOption.remove();

    let price = pageCloseOption.find('.option_price span').text().replace(/,/g, "");
    
    if(price){
        allPrice -= price;
        set_total_price();
    }      
})

//플러스 마이너스
$('.page_selected_options, .popup_selected_options').on('click','.btn_minus, .btn_plus',function() {

    console.log('btn_minus btn_plus');

    let idx = $(this).closest('.select_option_item').index();
    let pageQuantityOption = $('.page_selected_options .select_option_item').eq(idx);
    let popupQuantityOption =  $('.popup_selected_options .select_option_item').eq(idx);

    let quantityValue = $(this).siblings('.quantity').text();
    let optionPriceValue = $(this).parent().siblings('.option_price').children('span').text();
    let calcFlag = $(this).hasClass('btn_plus') ? 1 : -1;

    if($(this).hasClass('btn_minus') && quantityValue == 1) {
        return;
    }
    
    let calcQuantity = parseInt(quantityValue) + (calcFlag);
    
    if(optionPriceValue.length > 0) {
        const optionBasicPrice = parseInt(optionPriceValue.replace(/,/g, "")) / parseInt(quantityValue);
        if(priceType == 'fixed') {
            allPrice += optionBasicPrice * (calcFlag);
            set_total_price();
        }
        
        
        let priceStr = (optionBasicPrice * calcQuantity).toLocaleString();
        pageQuantityOption.find('.option_price span').text(priceStr);
        popupQuantityOption.find('.option_price span').text(priceStr);
    }


    pageQuantityOption.find('.quantity').text(calcQuantity);
    popupQuantityOption.find('.quantity').text(calcQuantity);        
});


function add_select_option_item(value, price, isPage, optionType, isExtProd = false) {
    console.log('add_select_option_item');

    let type = isPage ? "page" : "popup";
    let quantity = 1;

    selectOptionLI = 
    `<li class="select_option_item ${isExtProd ? 'select_ext_prod' : ''}">
        <div class="select_option_info">
            <span>${value}</span>
            <button type="button" class="btn_close"> X </button>
        </div>`;

    if(optionType == 'quantity' || price > 0) {
        selectOptionLI += `<div class="select_option_count">`;
        if(optionType == 'quantity') {    
            selectOptionLI += 
                `<div class="count_area">
                    <button type="button" class="btn_minus"> - </button>
                    <span class='quantity'>1</span>
                    <button type="button" class="btn_plus"> + </button>
                </div>`;
        }
        
        if(price > 0) {
            selectOptionLI += `<div class="option_price">${priceType == 'variable' ? '+' : ''} <span>${price.toLocaleString()}</span>원</div>`;  
        }
        selectOptionLI += `</div>`
    }
    selectOptionLI += `</li>`

    set_total_price();

    $(`.page_selected_options`).append(selectOptionLI);
    $(`.popup_selected_options`).append(selectOptionLI);

}

function set_total_price() {
    console.log('set_total_price');

    let totalPrice = 0;
    if(priceType == 'fixed') {
        if(allPrice > 0) {
            totalPrice = allPrice + parseInt(addWorkPrice);
        }
        $('.total_price strong').text(totalPrice.toLocaleString());  
    }
}

function open_bottom_sheet(target){
    $(target).addClass('is_show');
    $(".contants_cover").fadeIn(300);
    $("body").addClass("active");
}
function close_bottom_sheet(target){
    $(target).removeClass('is_show');
    $(".contants_cover").fadeOut(300);
    $("body").removeClass("active");
}



// 상세페이지 상단 이미지 영역
$(document).on('click','.estimateDetail_profile_swiper .swiper-slide',function(){
    if($(this).hasClass('empty_slide')) {
        return;
    }
    let bckImg = $(this).css('background-image');

    $(this).addClass('active').siblings().removeClass('active');
    $('.estimateDetail_profile_imgArea').css({
        backgroundImage:bckImg
    })
})

// 상세페이지 정보 영역 리스트
$(document).on('click','.estimateDetail_list_more_btn',function(){
    $(this).siblings('[class^="estimateDetail_contentBox_list"]').toggleClass("full");
});

//견적문의하기 버튼
$(document).on('click','.event_question_btn',function(){
   console.log('event_question_btn');

   //sessionStorage.setItem("SessionStorage price", 2000000);
   //localStorage.setItem("localStorage price", 100000);
});


function getIdxedDBValue(key) {
    console.log('getIdxedDBValue');
    const request = window.indexedDB.open('testIndexedDB');  // 1. DB 열기
    request.onerror =(e)=> console.log(e.target.errorCode);
  
    request.onsuccess =(e)=> {
      const db = request.result;
      const transaction = db.transaction('testStore');      
      transaction.onerror =(e)=> console.log('onerror');
      transaction.oncomplete =(e)=> console.log('oncomplete');
  
      const objStore = transaction.objectStore('testStore');
      const objStoreRequest = objStore.get(key);        // 2. get으로 데이터 접근
      objStoreRequest.onsuccess =(e)=> {
        console.log('objStoreRequest', objStoreRequest.result)
      }
    }
}

function updateIdxedDBValue(key, value) {
    var request = window.indexedDB.open('testIndexedDB');  // 1. db 열기
    request.onerror =(e)=> console.log(e.target.errorCode);
  
    request.onsuccess =(e)=> {
      var db = request.result;
      var transaction = db.transaction(["testStore"], 'readwrite');
      transaction.onerror =(e)=> console.log('onerror');
      transaction.oncomplete =(e)=> console.log('oncomplete');
  
      var objStore = transaction.objectStore("testStore");// 2. testStore 저장소 접근
      var objStoreRequest = objStore.get(key);       // 3. key값으로 데이터 접근

      objStoreRequest.onsuccess =(e)=> {
        var updateRequest = objStore.put(value);     // 4. 수정
        updateRequest.onerror =(e)=> console.log('udpate error');
              updateRequest.onsuccess =(e)=> console.log('onsuccess');
      }
    }
  }

function updateIdxedDBValue2(key, value){
    console.log('updateIdxedDBValue2');


    var request = window.indexedDB.open('testIndexedDB');  // 1. db 열기
    request.onerror =(e)=> console.log(e.target.errorCode);

    var db = request.result;

    let transaction = db.transaction(['testStore'], 'readwrite')
    let objectStore = transaction.objectStore('testStore')


    let updateRequest = objectStore.put(1234, 1)


}

//스토리지 저장 버튼
$(document).on('click','.storage_btn',function(){
    console.log('storage_btn');
 
    sessionStorage.setItem("SessionStorage price", 2000000);
    localStorage.setItem("localStorage price", 100000);


    // indexedDB
    if (window.indexedDB) {
        var name = 'testIndexedDB';
        var version = 1;
        var db = null;
        // IDBOpenDBRequest
        var request = indexedDB.open(name, version);
        // 기존의 저장된 데이터베이스보다 큰 버전 번호의 데이터베이스가 로드 될 때 트리거된다.
        request.onupgradeneeded = function(event) { 
          console.log('onupgradeneeded');
          // IDBDatabase
          db = request.result;
          var key = "id";
          var name = 'testStore';
          // IDBObjectStore
          var store = db.createObjectStore(name, { keyPath: key });
          var indexName = 'by_name';
          var price = 'price';
          // IDBIndex
          var index = store.createIndex(indexName, keyPath);
          var obj = {
            [key]: 1,
            [price]: "name"
          };
          store.put({
           [key]: 1,
           [price]: 100000
          });
        };
        request.onsuccess = function(event) {
          console.log('onsuccess');
          /*
          db = request.result;
          // IDBTransaction
          var transaction = db.transaction(['testStore'], "readonly");
          // IDBObjectStore
          var objectStore = transaction.objectStore('testStore');
          // IDBRequest
          var cursor = objectStore.openCursor();
            cursor.onsuccess = function(event) {
              // IDBCursorWithValue
              var cursor = event.target.result;
              if ( cursor ) {
                // {id: 1, name: "name"}
                console.log(cursor.value)
                cursor.continue();
              } else {
                console.log('end');
              }
            };*/
        };
      }
      updateIdxedDBValue2(1,30000000);
      //updateIdxedDBValue(1,30000000);
      //updateIdxedDBValue(2,50000000);
      //updateIdxedDBValue(3,70000000);


      //getIdxedDBValue(3);

 });

 $(document).on('click','.storage_load_btn',function(){
    console.log('storage_load_btn');
 


 });

 

$(document).ready(function () {

    basicPrice = parseInt($('.valid_price').text().replace(/[^\d]/g, ''));

    $('.dropdown_toggle').click(function () {
        console.log('dropdown_toggle!!!');

        var parent = $(this).closest('.select_dropdown');
        if (parent.hasClass('is_active')){
            parent.removeClass('is_active');
        }else {
            $('.select_dropdown').removeClass('is_active');
            parent.addClass('is_active');
        }
    });

    $('.dropdown_item').click(function () {
        var parent = $(this).closest('.select_dropdown');
        parent.removeClass('is_active');
        parent.children('.dropdown_toggle').children('span').text($(this).text());

        if($(this).hasClass('page_option_item')) {
            optionSelect(true, this)
        }else {
            optionSelect(false, this)
        };
    });

    // 옵션은 없지만 추가상품이 있는 경우와 둘 다 없는 경우 총 상품 금액에 상품 금액 설정
    if((ext_prod_data.length > 0 && option_data.length == 0) || (ext_prod_data.length == 0 && option_data.length == 0)) {
        allPrice = basicPrice;
        set_total_price();
    }

    
    imgSkeletonLoading('.swiper-slide, .estimateDetail_movie_item, .liveMov, .estimateDetail_profile_imgArea');    
});

</script>